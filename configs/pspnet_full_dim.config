# Traing baseline PSPNet model from ResNet 50 weights with 713 crop.

model {
    pspnet {
        num_classes: 19
        filter_scale: 1.0
        scale_predictions: true
        train_reduce: true
        feature_extractor {
            type: 'dilated_resnet50'
        }
        hyperparams {
            batch_norm {
                train: true
                scale: true
                center: true
                decay: 0.9997
                epsilon: 0.00001
            }
            regularizer {
                l2_regularizer {
                     weight: 0.0001
                }
            }
            initializer {
                variance_scaling_initializer {}
            }
        }
        loss {
            classification_loss {
                softmax {}
            }
            dist_loss {
                none {}
            }
            use_auxiliary_loss: true
            ignore_label: [255]
        }
    }
}

train_config: {
    batch_size: 8
    num_steps: 10000
    fine_tune_checkpoint_type: "segmentation"
    fine_tune_checkpoint: "train_logs/resnet/model.ckpt-8293"
    optimizer {
        momentum_optimizer: {
            learning_rate: {
                polynomial_decay_learning_rate {
                    initial_learning_rate: 0.001
                    decay_steps: 200000
                    power: 0.9
                }
            }
            momentum_optimizer_value: 0.9
        }
    }
    preprocessor_step {
        random_image_scale {
            min_scale_ratio: 0.5
            max_scale_ratio: 2.0
        }
    }
    preprocessor_step {
        random_image_crop {
            crop_height: 713
            crop_width: 713
            images_channel_dim: 3
            labels_channel_dim: 1
        }
    }
    preprocessor_step {
        random_horizontal_flip {}
    }
    batch_queue_capacity: 150
    num_batch_queue_threads: 35
    prefetch_queue_capacity: 10
}

train_input_reader: {
    num_examples: 2975
    shuffle: true
    tf_record_input_reader {
        input_path: "datasets/cityscapes_train.record"
    }
    num_readers: 25
    height: 1024
    width: 2048
}

eval_config: {
    num_examples: 500
    eval_input_type {
        padded_eval_input {
            height: 1025
            width: 2049
        }
    }
    flipped: true
    ignore_label: [255]
}

eval_input_reader: {
    num_examples: 500
    shuffle: false
    tf_record_input_reader {
        input_path: "datasets/cityscapes_val.record"
    }
    num_readers: 5
    height: 1024
    width: 2048
}

ood_config: {
    num_examples: 500
    eval_input_type {
        padded_eval_input {
            height: 1025
            width: 2049
        }
    }
    flipped: true
    ignore_label: [255]
}

ood_train_input_reader: {
    shuffle: false
    tf_record_input_reader {
        #input_path: "datasets/wild_val.record"
        #input_path: "/home/m2angus/city_data_str/cityscapes_val.record"
        input_path: "datasets/sun_train.record"
    }
    num_readers: 5
    num_examples: 681
    rheight: 1024
    rwidth: 2048
}

ood_eval_input_reader: {
    shuffle: false
    tf_record_input_reader {
        #input_path: "datasets/wild_val.record"
        #input_path: "/home/m2angus/city_data_str/cityscapes_val.record"
        input_path: "datasets/sun_val.record"
    }
    num_readers: 5
    num_examples: 2044
    rheight: 1024
    rwidth: 2048
}
